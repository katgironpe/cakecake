// Generated by CoffeeScript 1.3.3
(function() {
  var AppData, Art, Block, Builder, Editor, Entity, Explosion, Fireball, Game, GameController, Grid, Hero, ImageLoader, Keyboard, Level, Level2, Physics, Sprite, Text, World, dbtest, drawCircle, drawPolygon, drawSegment, drawTransform, getCanvasDebugDraw, setColorFromDebugDrawCallback,
    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

  Art = (function() {

    function Art() {}

    Art.offset_x = 0;

    Art.offset_y = 0;

    Art._scale = 1;

    Art.get_alpha = function() {
      return Game.context.globalAlpha;
    };

    Art.alpha = function(alpha) {
      return Game.context.globalAlpha = alpha;
    };

    Art.color = function(color) {
      Game.context.fillStyle = color;
      return Game.context.strokeStyle = color;
    };

    Art.fill_color = function(color) {
      return Game.context.fillStyle = color;
    };

    Art.stroke_color = function(color) {
      return Game.context.strokeStyle = color;
    };

    Art.lineC = function(x, y, x2, y2) {
      Game.context.beginPath();
      Game.context.moveTo(x + 0.5, y + 0.5);
      Game.context.lineTo(x2 + 0.5, y2 + 0.5);
      return Game.context.stroke();
    };

    Art.line = function(x, y, x2, y2) {
      return Art.lineC(x + Art.offset_x, y + Art.offset_y, x2 + Art.offset_x, y2 + Art.offset_y);
    };

    Art.rectangleC = function(x, y, w, h, filled) {
      if (filled == null) {
        filled = false;
      }
      if (filled === true) {
        return Game.context.fillRect(x, y, w, h);
      } else {
        return Game.context.strokeRect(x, y, w, h);
      }
    };

    Art.rectangle = function(x, y, w, h, filled) {
      if (filled == null) {
        filled = false;
      }
      return Art.rectangleC(x + Art.offset_x, y + Art.offset_y, w, h, filled);
    };

    return Art;

  })();

  Entity = (function() {

    function Entity() {}

    Entity.prototype.x = 0;

    Entity.prototype.y = 0;

    Entity.prototype.sx = 0;

    Entity.prototype.sy = 0;

    Entity.prototype.w = void 0;

    Entity.prototype.h = void 0;

    Entity.prototype.r = 0;

    Entity.prototype.visible = true;

    Entity.prototype.name = null;

    Entity.prototype.scale_x = 1;

    Entity.prototype.scale_y = 1;

    Entity.prototype.offset_x = 0;

    Entity.prototype.offset_y = 0;

    Entity.prototype.alpha = 1;

    Entity.prototype.rotation = 0;

    Entity.prototype.index = 1;

    Entity.prototype.sprite = null;

    Entity.prototype.world = null;

    Entity.prototype.z = 0;

    Entity.prototype.draw = function() {
      if (this.sprite) {
        this.sprite.x = this.x;
        this.sprite.y = this.y;
        return this.sprite.draw();
      }
    };

    Entity.prototype.init = function() {
      return null;
    };

    Entity.prototype.step = function() {
      return null;
    };

    Entity.prototype.move_towards = function(x, y, speed) {
      var dir;
      dir = this.direction_to(x, y);
      this.x += Math.cos(dir / 180 * Math.PI) * speed;
      return this.y -= Math.sin(dir / 180 * Math.PI) * speed;
    };

    Entity.prototype.direction_to = function(x, y) {
      var dx, dy;
      dx = x - this.x;
      dy = y - this.y;
      return -Math.atan2(dy, dx) * 180 / Math.PI;
    };

    Entity.prototype.nearest = function(c) {
      var distance, e, nearest, shortest, _i, _len, _ref;
      shortest = 9999;
      nearest = null;
      _ref = this.world.all_entities();
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        e = _ref[_i];
        if (e.name === c && e !== this) {
          distance = this.objects_distance(this, e);
          if (distance < shortest) {
            nearest = e;
            shortest = distance;
          }
        }
      }
      return nearest;
    };

    Entity.prototype.hit = function(c) {
      var e, _i, _len, _ref;
      _ref = this.world.all_entities();
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        e = _ref[_i];
        if (e.name === c) {
          if (this.objects_touch(this, e)) {
            return e;
          }
        }
      }
      return null;
    };

    Entity.prototype.hits = function(c) {
      var e, res, _i, _len, _ref;
      res = [];
      _ref = this.world.all_entities();
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        e = _ref[_i];
        if (e.name === c) {
          if (this.objects_touch(this, e)) {
            res.push(e);
          }
        }
      }
      return res;
    };

    Entity.prototype.objects_touch_circle = function() {
      return this.objects_distance(obj1, obj2) <= obj1.r + obj2.r;
    };

    Entity.prototype.objects_touch = function(obj1, obj2) {
      var d1, d2, l1, l2, r1, r2, u1, u2;
      l1 = obj1.x - obj1.w / 2;
      r1 = obj1.x + obj1.w / 2;
      l2 = obj2.x - obj2.w / 2;
      r2 = obj2.x + obj2.w / 2;
      u1 = obj1.y - obj1.h / 2;
      d1 = obj1.y + obj1.h / 2;
      u2 = obj2.y - obj2.h / 2;
      d2 = obj2.y + obj2.h / 2;
      return r1 > l2 && l1 < r2 && d1 > u2 && u1 < d2;
    };

    Entity.prototype.objects_distance = function(obj1, obj2) {
      return this.points_distance(obj1.x, obj1.y, obj2.x, obj2.y);
    };

    Entity.prototype.points_distance = function(x1, y1, x2, y2) {
      return Math.sqrt(Math.pow(x1 - x2, 2) + Math.pow(y1 - y2, 2));
    };

    Entity.prototype.destroy = function() {
      return this.world.destroy(this);
    };

    Entity.prototype.reset = function() {
      this.x = this.sx;
      return this.y = this.sy;
    };

    Entity.prototype.mouse_hits = function() {
      return Keyboard.MOUSE_X > this.x - this.w / 2 && Keyboard.MOUSE_X < this.x + this.w / 2 && Keyboard.MOUSE_Y > this.y - this.h / 2 && Keyboard.MOUSE_Y < this.y + this.h / 2;
    };

    return Entity;

  })();

  using_physics(Box2D, "b2.+");

  Game = (function() {

    function Game() {}

    Game.context = null;

    Game.worlds = [];

    Game.images = {};

    Game.zoom_level = 1;

    Game.pause = false;

    Game.editor = null;

    Game.mode = "";

    Game.physics_world = null;

    Game.add_world = function() {
      return Game.worlds.push(new World);
    };

    Game.init = function(mode) {
      var i;
      this.mode = mode;
      Game.context = Game.create_canvas();
      Game.set_zoom(AppData.scale);
      Game.setup_keyboard();
      i = new ImageLoader();
      i.onload = Game.start;
      return i.load_images();
    };

    Game.start = function() {
      Game.add_world();
      if (Game.mode === "build") {
        Game.editor = new Editor(Game.worlds[0]);
      }
      return setInterval(Game.run, 16);
    };

    Game.set_zoom = function(rate) {
      Game.context.scale(rate / Game.zoom_level, rate / Game.zoom_level);
      return Game.zoom_level = rate;
    };

    Game.create_canvas = function() {
      var canvas, context;
      canvas = document.createElement("canvas");
      canvas.width = AppData.width * AppData.scale;
      canvas.height = AppData.height * AppData.scale;
      document.body.appendChild(canvas);
      context = canvas.getContext("2d");
      context.textBaseline = 'top';
      context.imageSmoothingEnabled = false;
      context.mozImageSmoothingEnabled = false;
      context.webkitImageSmoothingEnabled = false;
      return context;
    };

    Game.setup_keyboard = function() {
      var canvas,
        _this = this;
      canvas = document.getElementsByTagName("canvas")[0];
      document.body.onkeydown = function() {
        return Keyboard.key_pressed(event.keyCode);
      };
      document.body.onkeyup = function() {
        return Keyboard.key_released(event.keyCode);
      };
      canvas.onmousemove = function() {
        return Keyboard.mouse_move(event);
      };
      canvas.onmousedown = function() {
        return Keyboard.mouse_down(event.which);
      };
      canvas.onmouseup = function() {
        return Keyboard.mouse_up(event.which);
      };
      canvas.oncontextmenu = function() {
        return false;
      };
      canvas.addEventListener("touchstart", Keyboard.touch_start, false);
      canvas.addEventListener("touchend", Keyboard.touch_end, false);
      canvas.addEventListener("touchcancel", Keyboard.touch_end, false);
      canvas.addEventListener("touchleave", Keyboard.touch_end, false);
      return canvas.addEventListener("touchmove", Keyboard.touch_move, false);
    };

    Game.run = function() {
      var world, _i, _len, _ref;
      _ref = Game.worlds;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        world = _ref[_i];
        world.step();
        world.draw();
      }
      if (Game.editor) {
        Game.editor.step();
        return Game.editor.draw();
      }
    };

    return Game;

  }).call(this);

  ImageLoader = (function() {
    var i, images_loaded, images_n;

    images_loaded = 0;

    images_n = 0;

    i = null;

    function ImageLoader() {
      this.image_loaded = __bind(this.image_loaded, this);
      images_n = Object.keys(AppData.sprites).length;
    }

    ImageLoader.prototype.load_images = function() {
      var file, name, _ref, _results;
      _ref = AppData.sprites;
      _results = [];
      for (name in _ref) {
        file = _ref[name];
        _results.push(this.load_image("sprites/" + file, name));
      }
      return _results;
    };

    ImageLoader.prototype.load_image = function(url, name, im) {
      var image,
        _this = this;
      image = new Image;
      image.src = url;
      image.onload = function() {
        return _this.image_loaded(name, image);
      };
      return image;
    };

    ImageLoader.prototype.image_loaded = function(name, image) {
      Game.images[name] = image;
      images_loaded += 1;
      if (images_loaded === images_n) {
        return this.onload();
      }
    };

    return ImageLoader;

  })();

  Keyboard = (function() {

    function Keyboard() {}

    Keyboard._keyCodes = {
      'BACKSPACE': 8,
      'TAB': 9,
      'ENTER': 13,
      'SHIFT': 16,
      'CTRL': 17,
      'ALT': 18,
      'CAPSLOCK': 20,
      'ESCAPE': 27,
      'SPACE': 32,
      'END': 35,
      'HOME': 36,
      'LEFT': 37,
      'UP': 38,
      'RIGHT': 39,
      'DOWN': 40,
      'INSERT': 45,
      'DELETE': 46,
      '0': 48,
      '1': 49,
      '2': 50,
      '3': 51,
      '4': 52,
      '5': 53,
      '6': 54,
      '7': 55,
      '8': 56,
      '9': 57,
      'A': 65,
      'B': 66,
      'C': 67,
      'D': 68,
      'E': 69,
      'F': 70,
      'G': 71,
      'H': 72,
      'I': 73,
      'J': 74,
      'K': 75,
      'L': 76,
      'M': 77,
      'N': 78,
      'O': 79,
      'P': 80,
      'Q': 81,
      'R': 82,
      'S': 83,
      'T': 84,
      'U': 85,
      'V': 86,
      'W': 87,
      'X': 88,
      'Y': 89,
      'Z': 90,
      'MULTIPLY': 106,
      'ADD': 107,
      'SUBTRACT': 109,
      'MOUSE_LEFT': 'MOUSE_LEFT',
      'MOUSE_MIDDLE': 'MOUSE_MIDDLE',
      'MOUSE_RIGHT': 'MOUSE_RIGHT',
      'TOUCH': 'TOUCH'
    };

    Keyboard._pre_pressed = [];

    Keyboard._pre_released = [];

    Keyboard._pressed = [];

    Keyboard._released = [];

    Keyboard._hold = [];

    Keyboard.key_released = function(c) {
      return Keyboard._pre_released.push(c);
    };

    Keyboard.key_pressed = function(c) {
      return Keyboard._pre_pressed.push(c);
    };

    Keyboard.touch_start = function(e) {
      return Keyboard._pre_pressed.push('TOUCH');
    };

    Keyboard.touch_end = function(e) {
      return Keyboard._pre_released.push('TOUCH');
    };

    Keyboard.touch_move = function(e) {
      Keyboard.TOUCH_X = e.touches[0].pageX;
      return Keyboard.TOUCH_Y = e.touches[0].pageY;
    };

    Keyboard.mouse_down = function(e) {
      switch (e) {
        case 1:
          Keyboard._pre_pressed.push('MOUSE_LEFT');
          break;
        case 2:
          Keyboard._pre_pressed.push('MOUSE_MIDDLE');
          break;
        case 3:
          Keyboard._pre_pressed.push('MOUSE_RIGHT');
      }
      return false;
    };

    Keyboard.mouse_up = function(e) {
      switch (e) {
        case 1:
          Keyboard._pre_released.push('MOUSE_LEFT');
          break;
        case 2:
          Keyboard._pre_released.push('MOUSE_MIDDLE');
          break;
        case 3:
          Keyboard._pre_released.push('MOUSE_RIGHT');
      }
      return false;
    };

    Keyboard.mouse_move = function(e) {
      Keyboard.MOUSE_XC = e.offsetX / Game.zoom_level;
      Keyboard.MOUSE_YC = e.offsetY / Game.zoom_level;
      Keyboard.MOUSE_X = Keyboard.MOUSE_XC - Art.offset_x;
      return Keyboard.MOUSE_Y = Keyboard.MOUSE_YC - Art.offset_y;
    };

    Keyboard.hold = function(keyName) {
      return Keyboard._hold.indexOf(Keyboard._keyCodes[keyName]) !== -1;
    };

    Keyboard.press = function(keyName) {
      return Keyboard._pressed.indexOf(Keyboard._keyCodes[keyName]) !== -1;
    };

    Keyboard.release = function(keyName) {
      return Keyboard._released.indexOf(Keyboard._keyCodes[keyName]) !== -1;
    };

    Keyboard.step = function() {
      Keyboard._pressed = Keyboard._pre_pressed.splice(0);
      Keyboard._released = Keyboard._pre_released.splice(0);
      Keyboard._hold = Keyboard._hold.concat(Keyboard._pressed);
      Keyboard._hold = Keyboard._hold.diff(Keyboard._released);
      Keyboard._pre_pressed = [];
      return Keyboard._pre_released = [];
    };

    return Keyboard;

  })();

  using_physics(Box2D, "b2.+");

  Physics = (function() {

    Physics.prototype.world = null;

    Physics.prototype.solid = null;

    Physics.prototype.PTM = 16;

    function Physics() {
      this.create_world();
      this.setup_debug_draw();
      this.solid = this.world.CreateBody(new b2BodyDef());
      this.build_edges();
      this.build_boxes();
    }

    Physics.prototype.create_world = function() {
      return this.world = new b2World(new b2Vec2(0.0, 10.0));
    };

    Physics.prototype.setup_debug_draw = function() {
      var myDebugDraw;
      myDebugDraw = getCanvasDebugDraw();
      myDebugDraw.SetFlags(e_shapeBit);
      return this.world.SetDebugDraw(myDebugDraw);
    };

    Physics.prototype.build_edges = function() {
      this.build_solid_line(0, 0, AppData.width, 0);
      this.build_solid_line(0, AppData.height, AppData.width, AppData.height);
      this.build_solid_line(0, 0, 0, AppData.height);
      return this.build_solid_line(AppData.width, 0, AppData.width, AppData.height);
    };

    Physics.prototype.build_boxes = function() {
      return this.build_solid_box(130, 60, 100, 4, 0);
    };

    Physics.prototype.build_solid_line = function(x1, y1, x2, y2) {
      var line;
      line = new b2EdgeShape();
      line.Set(new b2Vec2(x1 / this.PTM, y1 / this.PTM), new b2Vec2(x2 / this.PTM, y2 / this.PTM));
      return this.solid.CreateFixture(line, 0.0);
    };

    Physics.prototype.build_solid_box = function(x, y, w, h, rotation) {
      var box;
      box = new b2PolygonShape();
      box.SetAsBox(w / this.PTM, h / this.PTM, new b2Vec2(x / this.PTM, y / this.PTM), (rotation / 360) * (Math.PI * 2));
      return this.solid.CreateFixture(box, 0.0);
    };

    Physics.prototype.draw = function() {
      Game.context.save();
      Game.context.scale(this.PTM, this.PTM);
      Game.context.lineWidth /= this.PTM;
      this.world.DrawDebugData(Game.context);
      return Game.context.restore();
    };

    return Physics;

  })();

  Sprite = (function() {

    Sprite.prototype.x = 0;

    Sprite.prototype.y = 0;

    Sprite.prototype.visible = true;

    Sprite.prototype.scale_x = 1;

    Sprite.prototype.scale_y = 1;

    Sprite.prototype.alpha = 1;

    Sprite.prototype.rotation = 0;

    Sprite.prototype.index = 1;

    Sprite.prototype.z = 0;

    Sprite.prototype.name = null;

    function Sprite(name, x, y) {
      if (name == null) {
        name = 'PlaceHolder';
      }
      if (x == null) {
        x = 0;
      }
      if (y == null) {
        y = 0;
      }
      this.name = name;
      this.x = x;
      this.y = y;
    }

    Sprite.prototype.draw = function() {
      var image, x, y;
      image = this._get_image();
      x = this.x - image.width / 2 + Art.offset_x;
      y = this.y - image.height / 2 + Art.offset_y;
      if (this.rotation === 0 && this.scale_x === 1 && this.scale_y === 1) {
        return Game.context.drawImage(image, 0, 0, image.width, image.height, x, y, image.width, image.height);
      } else {
        Game.context.save();
        Game.context.translate(x + image.width / 2, y + image.height / 2);
        Game.context.scale(this.scale_x, this.scale_y);
        Game.context.rotate(Math.PI / 180 * (0 - this.rotation));
        Game.context.drawImage(image, 0, 0, image.width, image.height, -image.width / 2, -image.height / 2, image.width, image.height);
        return Game.context.restore();
      }
    };

    Sprite.prototype._get_image = function() {
      var result;
      if (this.index !== 1) {
        result = Game.images[this.name + this.index];
      } else {
        result = Game.images[this.name];
      }
      if (!result) {
        console.log("" + name + " not found.");
        result = Game.images['PlaceHolder'];
      }
      return result;
    };

    return Sprite;

  })();

  Text = (function() {

    Text.prototype.x = 0;

    Text.prototype.y = 0;

    Text.prototype.visible = true;

    Text.prototype.scale_x = 1;

    Text.prototype.scale_y = 1;

    Text.prototype.alpha = 1;

    Text.prototype.rotation = 0;

    Text.prototype.index = 1;

    Text.prototype.align = 'center';

    Text.prototype.z = 0;

    Text.prototype.name = null;

    Text.prototype.font = 'Dosis';

    Text.prototype.font_size = 16;

    Text.prototype.font_style = "";

    Text.prototype.string = '';

    function Text(string, x, y) {
      if (string == null) {
        string = '';
      }
      if (x == null) {
        x = 0;
      }
      if (y == null) {
        y = 0;
      }
      this.string = string;
      this.x = x;
      this.y = y;
    }

    Text.prototype.draw = function(string, x, y) {
      if (string == null) {
        string = '';
      }
      if (x == null) {
        x = 0;
      }
      if (y == null) {
        y = 0;
      }
      this._update();
      if (this.rotation !== 0) {
        Game.context.save();
        Game.context.translate(this.x + get_width() / 2, this.y + this.get_height() / 2);
        Game.context.rotate(Math.PI / 180 * this.rotation);
        Game.context.fillText(this.string, -this.get_width() / 2, -this.get_height() / 2);
        return Game.context.restore();
      } else {
        return Game.context.fillText(this.string, this.x, this.y);
      }
    };

    Text.prototype.get_width = function() {
      this._update();
      return Game.context.measureText(this.string).width;
    };

    Text.prototype.get_height = function() {
      return this.font_size;
    };

    Text.prototype._update = function() {
      Game.context.font = this.font_style + " " + this.font_size + " " + this.font;
      return Game.context.textAlign = this.align;
    };

    return Text;

  })();

  Array.prototype.remove = function(e) {
    var t, _ref;
    if ((t = this.indexOf(e)) > -1) {
      return ([].splice.apply(this, [t, t - t + 1].concat(_ref = [])), _ref);
    }
  };

  Array.prototype.diff = function(a) {
    return this.filter(function(i) {
      return !(a.indexOf(i) > -1);
    });
  };

  Array.prototype.copy = function() {
    return this.slice(0);
  };

  Math.sign = function(n) {
    return (n > 0 ? 1 : (n < 0 ? -1 : 0));
  };

  Array.prototype.unique = function() {
    return this.sort().filter(function(v, i, o) {
      if (i && v !== o[i - 1]) {
        return v;
      } else {
        return 0;
      }
    });
  };

  Array.prototype.deepToString = function() {
    var i, result, _i, _ref;
    result = "[";
    for (i = _i = 0, _ref = this.length; 0 <= _ref ? _i < _ref : _i > _ref; i = 0 <= _ref ? ++_i : --_i) {
      if (Object.prototype.toString.call(this[i]) === "[object Array]") {
        result += this[i].deepToString();
      } else if (this[i]) {
        result += this[i];
      }
      if (i !== this.length - 1) {
        result += ",";
      }
    }
    return result + "]";
  };

  Audio.muted = false;

  Audio.prototype.go = function() {
    if (Audio.muted === false) {
      return this.play();
    }
  };

  World = (function() {

    World.prototype._entities = [];

    World.prototype._entities_to_destroy = [];

    World.prototype.x = 0;

    World.prototype.y = 0;

    World.prototype.pause = false;

    World.prototype.physics = null;

    function World() {
      if (AppData.physics) {
        this.physics = new Physics;
      }
    }

    World.prototype.load_level = function(name) {
      var key, level, value, _ref, _results;
      level = AppData.levels[name];
      _ref = level.data;
      _results = [];
      for (key in _ref) {
        value = _ref[key];
        _results.push(this.spawn(value.name, value.x, value.y));
      }
      return _results;
    };

    World.prototype.destroy_all = function() {
      var e, temp, _i, _len, _results;
      temp = this._entities.slice(0);
      _results = [];
      for (_i = 0, _len = temp.length; _i < _len; _i++) {
        e = temp[_i];
        _results.push(this._entities.remove(e));
      }
      return _results;
    };

    World.prototype.reset = function() {
      this.destroy_all();
      return this.load_level('Level');
    };

    World.prototype.all_entities = function() {
      return this._entities;
    };

    World.prototype.destroy = function(entity) {
      return this._entities_to_destroy.push(entity);
    };

    World.prototype._remove_destroyed = function() {
      var e, _i, _len, _ref;
      _ref = this._entities_to_destroy;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        e = _ref[_i];
        this._entities.remove(e);
      }
      return this._entities_to_destroy = [];
    };

    World.prototype.spawn = function(name, x, y) {
      var cl, entity;
      if (x == null) {
        x = 0;
      }
      if (y == null) {
        y = 0;
      }
      cl = AppData.entities[name];
      if (!cl) {
        console.log("Error: " + name + " not found");
      }
      entity = new cl;
      entity.world = this;
      entity.sx = x;
      entity.sy = y;
      if (entity.name === null) {
        entity.name = name;
      }
      if (entity.sprite === null) {
        entity.sprite = new Sprite;
        if (!Game.images[name]) {
          name = 'PlaceHolder';
        }
        entity.sprite.name = name;
        entity.w = Game.images[name].width;
        entity.h = Game.images[name].height;
        entity.r = (entity.w + entity.h) / 4;
      }
      this._entities.push(entity);
      entity.reset();
      entity.init();
      return entity;
    };

    World.prototype.objects_of_class = function(c) {
      var entity, res, _i, _len, _ref;
      res = [];
      _ref = this._entities;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        entity = _ref[_i];
        if (entity.name === c) {
          res.push(entity);
        }
      }
      return res;
    };

    World.prototype.number_of = function(c) {
      return this.objects_of_class(c).length;
    };

    World.prototype.exists = function(c) {
      return this.number_of(c) > 0;
    };

    World.prototype.draw = function() {
      var entity, _i, _len, _ref, _results;
      Art.color('#EFF8FB');
      Art.rectangleC(0, 0, AppData.width * AppData.scale / Game.zoom_level, AppData.height * AppData.scale / Game.zoom_level, true);
      Art.color('#000000');
      if (this.physics) {
        this.physics.draw();
      }
      this._entities.sort(function(a, b) {
        if (Math.sign(a.z - b.z) === 0) {
          return Math.sign(a.y - b.y);
        } else {
          return Math.sign(a.z - b.z);
        }
      });
      _ref = this._entities;
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        entity = _ref[_i];
        _results.push(entity.draw());
      }
      return _results;
    };

    World.prototype.step = function() {
      var entity, _i, _len, _ref;
      this.physics.world.Step(1 / 120, 3, 2);
      Keyboard.step();
      if (this.pause === false) {
        _ref = this._entities;
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          entity = _ref[_i];
          if (typeof entity.step === "function") {
            entity.step();
          }
        }
      }
      return this._remove_destroyed();
    };

    return World;

  })();

  Block = (function(_super) {

    __extends(Block, _super);

    function Block() {
      return Block.__super__.constructor.apply(this, arguments);
    }

    return Block;

  })(Entity);

  dbtest = (function(_super) {

    __extends(dbtest, _super);

    function dbtest() {
      return dbtest.__super__.constructor.apply(this, arguments);
    }

    return dbtest;

  })(Entity);

  setColorFromDebugDrawCallback = function(color) {
    var blue, col, colStr, green, red;
    col = Box2D.wrapPointer(color, b2Color);
    red = (col.get_r() * 255) | 0;
    green = (col.get_g() * 255) | 0;
    blue = (col.get_b() * 255) | 0;
    colStr = red + "," + green + "," + blue;
    Game.context.fillStyle = "rgba(" + colStr + ",0.5)";
    return Game.context.strokeStyle = "rgb(" + colStr + ")";
  };

  drawSegment = function(vert1, vert2) {
    var vert1V, vert2V;
    vert1V = Box2D.wrapPointer(vert1, b2Vec2);
    vert2V = Box2D.wrapPointer(vert2, b2Vec2);
    Game.context.beginPath();
    Game.context.moveTo(vert1V.get_x(), vert1V.get_y());
    Game.context.lineTo(vert2V.get_x(), vert2V.get_y());
    return Game.context.stroke();
  };

  drawPolygon = function(vertices, vertexCount, fill) {
    var tmpI, vert;
    Game.context.beginPath();
    tmpI = 0;
    while (tmpI < vertexCount) {
      vert = Box2D.wrapPointer(vertices + (tmpI * 8), b2Vec2);
      if (tmpI === 0) {
        Game.context.moveTo(vert.get_x(), vert.get_y());
      } else {
        Game.context.lineTo(vert.get_x(), vert.get_y());
      }
      tmpI++;
    }
    Game.context.closePath();
    if (fill) {
      Game.context.fill();
    }
    return Game.context.stroke();
  };

  drawCircle = function(center, radius, axis, fill) {
    var axisV, centerV, vert2V;
    centerV = Box2D.wrapPointer(center, b2Vec2);
    axisV = Box2D.wrapPointer(axis, b2Vec2);
    Game.context.beginPath();
    Game.context.arc(centerV.get_x(), centerV.get_y(), radius, 0, 2 * Math.PI, false);
    if (fill) {
      Game.context.fill();
    }
    Game.context.stroke();
    if (fill) {
      vert2V = copyVec2(centerV);
      vert2V.op_add(scaledVec2(axisV, radius));
      Game.context.beginPath();
      Game.context.moveTo(centerV.get_x(), centerV.get_y());
      Game.context.lineTo(vert2V.get_x(), vert2V.get_y());
      return Game.context.stroke();
    }
  };

  drawTransform = function(transform) {
    var pos, rot, trans;
    trans = Box2D.wrapPointer(transform, b2Transform);
    pos = trans.get_p();
    rot = trans.get_q();
    Game.context.save();
    Game.context.translate(pos.get_x(), pos.get_y());
    Game.context.scale(0.5, 0.5);
    Game.context.rotate(rot.GetAngle());
    Game.context.lineWidth *= 2;
    drawAxes(Game.context);
    return Game.context.restore();
  };

  getCanvasDebugDraw = function() {
    var debugDraw;
    debugDraw = new Box2D.b2Draw();
    Box2D.customizeVTable(debugDraw, [
      {
        original: Box2D.b2Draw.prototype.DrawSegment,
        replacement: function(ths, vert1, vert2, color) {
          setColorFromDebugDrawCallback(color);
          return drawSegment(vert1, vert2);
        }
      }
    ]);
    Box2D.customizeVTable(debugDraw, [
      {
        original: Box2D.b2Draw.prototype.DrawPolygon,
        replacement: function(ths, vertices, vertexCount, color) {
          setColorFromDebugDrawCallback(color);
          return drawPolygon(vertices, vertexCount, false);
        }
      }
    ]);
    Box2D.customizeVTable(debugDraw, [
      {
        original: Box2D.b2Draw.prototype.DrawSolidPolygon,
        replacement: function(ths, vertices, vertexCount, color) {
          setColorFromDebugDrawCallback(color);
          return drawPolygon(vertices, vertexCount, true);
        }
      }
    ]);
    Box2D.customizeVTable(debugDraw, [
      {
        original: Box2D.b2Draw.prototype.DrawCircle,
        replacement: function(ths, center, radius, color) {
          var dummyAxis;
          setColorFromDebugDrawCallback(color);
          dummyAxis = b2Vec2(0, 0);
          return drawCircle(center, radius, dummyAxis, false);
        }
      }
    ]);
    Box2D.customizeVTable(debugDraw, [
      {
        original: Box2D.b2Draw.prototype.DrawSolidCircle,
        replacement: function(ths, center, radius, axis, color) {
          setColorFromDebugDrawCallback(color);
          return drawCircle(center, radius, axis, true);
        }
      }
    ]);
    Box2D.customizeVTable(debugDraw, [
      {
        original: Box2D.b2Draw.prototype.DrawTransform,
        replacement: function(ths, transform) {
          return drawTransform(transform);
        }
      }
    ]);
    return debugDraw;
  };

  Explosion = (function(_super) {

    __extends(Explosion, _super);

    function Explosion() {
      return Explosion.__super__.constructor.apply(this, arguments);
    }

    Explosion.prototype.time = 0;

    Explosion.prototype.step = function() {
      this.time += 1;
      this.index = 1 + this.time;
      if (this.time > 3) {
        return this.destroy();
      }
    };

    return Explosion;

  })(Entity);

  Fireball = (function(_super) {

    __extends(Fireball, _super);

    function Fireball() {
      return Fireball.__super__.constructor.apply(this, arguments);
    }

    Fireball.prototype.time = 0;

    Fireball.prototype.step = function() {
      this.time += 1;
      this.x += Math.cos(this.direction / 180 * Math.PI) * 5;
      this.y -= Math.sin(this.direction / 180 * Math.PI) * 5;
      if (this.time > 15) {
        this.world.spawn('Explosion', this.x, this.y);
        return this.destroy();
      }
    };

    Fireball.prototype.draw = function() {
      this.sprite.index = 1 + this.direction / 45;
      return Fireball.__super__.draw.apply(this, arguments);
    };

    return Fireball;

  })(Entity);

  GameController = (function(_super) {

    __extends(GameController, _super);

    function GameController() {
      return GameController.__super__.constructor.apply(this, arguments);
    }

    GameController.score = 0;

    GameController.prototype.text = null;

    GameController.prototype.world = null;

    GameController.prototype.date = 0;

    GameController.prototype.init = function() {
      this.text = new Text('10', 10, 10);
      this.text.align = 'left';
      return this.createWorld();
    };

    GameController.prototype.createWorld = function() {
      var anchor, b4, bd, body, fd, i, jd, shape;
      shape = new b2PolygonShape();
      shape.SetAsBox(0.1, 1.0);
      fd = new b2FixtureDef();
      fd.set_shape(shape);
      fd.set_density(20.0);
      fd.set_friction(0.1);
      i = 0;
      while (i < 10) {
        bd = new b2BodyDef();
        bd.set_type(b2_dynamicBody);
        bd.set_position(new b2Vec2(10 - 6.0 + 1.0 * i, 2));
        body = this.world.physics.world.CreateBody(bd);
        body.CreateFixture(fd);
        ++i;
      }
      shape = new b2PolygonShape();
      shape.SetAsBox(0.25, 0.25);
      bd = new b2BodyDef();
      bd.set_type(b2_dynamicBody);
      bd.set_position(new b2Vec2(0, 0));
      b4 = this.world.physics.world.CreateBody(bd);
      b4.CreateFixture(shape, 10.0);
      jd = new b2RevoluteJointDef();
      anchor = new b2Vec2(10 - 2.0, 1.0 - 15);
      anchor.Set(10 - 7.0, 0);
      jd.Initialize(this.world.physics.solid, b4, anchor);
      return this.world.physics.world.CreateJoint(jd);
    };

    GameController.prototype.draw = function() {
      var sec, tmp_date;
      tmp_date = new Date;
      sec = tmp_date - this.date;
      this.date = tmp_date;
      this.text.string = sec;
      return this.text.draw();
    };

    return GameController;

  })(Entity);

  Hero = (function(_super) {

    __extends(Hero, _super);

    function Hero() {
      return Hero.__super__.constructor.apply(this, arguments);
    }

    Hero.prototype.direction = 0;

    Hero.prototype.move = 'WALKING';

    Hero.prototype.animation = 0;

    Hero.prototype.init = function() {};

    Hero.prototype.step = function() {
      var f, face_x, face_y, fireball_sound;
      face_x = 0;
      face_y = 0;
      if (Keyboard.hold('RIGHT')) {
        face_x += 1;
      }
      if (Keyboard.hold('LEFT')) {
        face_x -= 1;
      }
      if (Keyboard.hold('UP')) {
        face_y -= 1;
      }
      if (Keyboard.hold('DOWN')) {
        face_y += 1;
      }
      this.move = 'WALKING';
      if (face_x === -1) {
        if (face_y === -1) {
          this.direction = 90 + 45;
        }
        if (face_y === 0) {
          this.direction = 180;
        }
        if (face_y === 1) {
          this.direction = 180 + 45;
        }
      }
      if (face_x === 0) {
        if (face_y === -1) {
          this.direction = 90;
        }
        if (face_y === 0) {
          this.move = 'STANDING';
        }
        if (face_y === 1) {
          this.direction = 270;
        }
      }
      if (face_x === 1) {
        if (face_y === -1) {
          this.direction = 45;
        }
        if (face_y === 0) {
          this.direction = 0;
        }
        if (face_y === 1) {
          this.direction = 270 + 45;
        }
      }
      this.sprite.scale_x = 1;
      if (this.direction === 0) {
        this.sprite.index = 5;
      }
      if (this.direction === 45) {
        this.sprite.index = 7;
      }
      if (this.direction === 90) {
        this.sprite.index = 9;
      }
      if (this.direction === 90 + 45) {
        this.sprite.index = 7;
        this.sprite.scale_x = -1;
      }
      if (this.direction === 180) {
        this.sprite.index = 5;
        this.sprite.scale_x = -1;
      }
      if (this.direction === 180 + 45) {
        this.sprite.index = 3;
        this.sprite.scale_x = -1;
      }
      if (this.direction === 270) {
        this.sprite.index = 1;
      }
      if (this.direction === 270 + 45) {
        this.sprite.index = 3;
      }
      if (this.animation > 20) {
        this.animation = 0;
      }
      if (this.animation > 10) {
        this.sprite.index += 1;
      }
      if (this.move === 'WALKING') {
        this.animation += 1;
        this.x += Math.cos(this.direction / 180 * Math.PI);
        this.y -= Math.sin(this.direction / 180 * Math.PI);
        if (this.hit('Block')) {
          console.log('block');
          this.x -= Math.cos(this.direction / 180 * Math.PI);
          this.y += Math.sin(this.direction / 180 * Math.PI);
        }
      }
      if (Keyboard.press('X')) {
        fireball_sound = new Audio('sounds/shotgun.wav');
        fireball_sound.go();
        f = this.world.spawn('Fireball', this.x, this.y);
        f.direction = this.direction;
      }
      this.world.x = this.x - AppData.width / 2;
      return this.world.y = this.y - AppData.height / 2;
    };

    return Hero;

  })(Entity);

  Level = (function() {

    function Level() {}

    Level.data = {
      1: {
        name: 'GameController',
        x: 0,
        y: 0
      }
    };

    return Level;

  })();

  Level2 = (function() {

    function Level2() {}

    return Level2;

  })();

  Builder = (function() {

    Builder.prototype.active = true;

    Builder.prototype.hold = false;

    Builder.prototype.entity = null;

    Builder.prototype.world = null;

    Builder.prototype.grid = null;

    Builder.prototype.editor = null;

    function Builder(editor) {
      this.editor = editor;
      this.world = Game.worlds[0];
    }

    Builder.prototype.output_level = function(name) {
      var e, i, level, n, txt, _i;
      txt = "class " + name + "\n  @data:\n";
      level = AppData.levels[name];
      n = Object.keys(level.data).length;
      for (i = _i = 1; 1 <= n ? _i <= n : _i >= n; i = 1 <= n ? ++_i : --_i) {
        e = level.data[i];
        txt += "    " + i + ":\n";
        txt += "      name: '" + e.name + "'\n";
        txt += "      x: " + e.x + "\n";
        txt += "      y: " + e.y + "\n";
      }
      return txt;
    };

    Builder.prototype.save_level = function(name) {
      var e, i, level, o, _i, _len, _ref, _results;
      i = 1;
      level = AppData.levels[name];
      level.data = new Object();
      _ref = this.world.all_entities();
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        e = _ref[_i];
        o = new Object();
        o.name = e.name;
        o.x = e.sx;
        o.y = e.sy;
        level.data[i] = o;
        _results.push(i += 1);
      }
      return _results;
    };

    Builder.prototype.step = function() {
      var e, temp_all_entities, _i, _len;
      if (!this.grid) {
        this.grid = Game.editor.grid;
      }
      if (!this.active) {
        return;
      }
      if (Keyboard.press('MOUSE_LEFT')) {
        this.hold = this.world.spawn(this.entity, Keyboard.MOUSE_X, Keyboard.MOUSE_Y);
      }
      if (this.hold) {
        if (!Game.pause) {
          this.editor.set_pause(true);
        }
        this.hold.x = Keyboard.MOUSE_X;
        this.hold.y = Keyboard.MOUSE_Y;
        if (Keyboard.hold('SHIFT') && this.grid) {
          this.hold.x = this.hold.x - this.hold.x % this.grid.width + this.grid.width / 2;
          this.hold.y = this.hold.y - this.hold.y % this.grid.height + this.grid.height / 2;
        }
        this.hold.sx = this.hold.x;
        this.hold.sy = this.hold.y;
      }
      if (Keyboard.release('MOUSE_LEFT')) {
        this.save_level(this.editor.level);
        this.hold = null;
      }
      if (Keyboard.hold('MOUSE_RIGHT')) {
        this.editor.set_pause(true);
        temp_all_entities = this.world.all_entities().slice(0);
        for (_i = 0, _len = temp_all_entities.length; _i < _len; _i++) {
          e = temp_all_entities[_i];
          if (e.mouse_hits()) {
            e.destroy();
          }
        }
        return this.save_level(this.editor.level);
      }
    };

    return Builder;

  })();

  Editor = (function() {

    Editor.prototype.grid = null;

    Editor.prototype.builder = null;

    Editor.prototype.world = null;

    Editor.prototype.level = '';

    Editor.prototype.entity_selector = null;

    Editor.prototype.pause_button = null;

    Editor.prototype.grid_x = null;

    Editor.prototype.grid_y = null;

    Editor.prototype.grid_width = null;

    Editor.prototype.grid_height = null;

    Editor.prototype.grid_toggle = null;

    function Editor(world) {
      this.set_pause = __bind(this.set_pause, this);

      this.toggle_pause = __bind(this.toggle_pause, this);

      this.toggle_grid = __bind(this.toggle_grid, this);

      this.grid_move = __bind(this.grid_move, this);

      this.entity_change = __bind(this.entity_change, this);

      this.save = __bind(this.save, this);

      this.save_type_change = __bind(this.save_type_change, this);

      this.level_change = __bind(this.level_change, this);
      this.world = world;
      this.builder = new Builder(this);
      this.grid = new Grid;
      this.level_selector = document.getElementById("level_selector");
      this.level_selector.addEventListener("change", this.level_change, false);
      this.level_change();
      this.save_type_selector = document.getElementById("save_type_selector");
      this.save_type_selector.addEventListener("change", this.save_type_change, false);
      this.save_button = document.getElementById("save_button");
      this.save_button.addEventListener("click", this.save, false);
      this.entity_selector = document.getElementById("entity_selector");
      this.entity_selector.addEventListener("change", this.entity_change, false);
      this.entity_change();
      this.pause_button = document.getElementById("pause_toggle");
      this.pause_button.addEventListener("click", this.toggle_pause, false);
      this.pause_button.addEventListener("click", this.entity_change, false);
      this.grid_x = document.getElementById("grid_x");
      this.grid_y = document.getElementById("grid_y");
      this.grid_width = document.getElementById("grid_width");
      this.grid_height = document.getElementById("grid_height");
      this.grid_toggle = document.getElementById("grid_toggle");
      this.grid_x.addEventListener("change", this.grid_move, false);
      this.grid_y.addEventListener("change", this.grid_move, false);
      this.grid_width.addEventListener("change", this.grid_move, false);
      this.grid_height.addEventListener("change", this.grid_move, false);
      this.grid_toggle.addEventListener("click", this.toggle_grid, false);
    }

    Editor.prototype.step = function() {
      return this.builder.step();
    };

    Editor.prototype.level_change = function() {
      this.level = this.level_selector.value;
      console.log(this.level);
      this.world.destroy_all();
      return this.world.load_level(this.level);
    };

    Editor.prototype.save_type_change = function() {
      return this.builder.save_type = this.save_type_selector.value;
    };

    Editor.prototype.save = function() {
      var blob, level, txt;
      level = this.level_selector.value;
      txt = this.builder.output_level(level);
      blob = new Blob([txt], {
        type: 'text/html'
      });
      return saveAs(blob, "" + level + ".coffee");
    };

    Editor.prototype.entity_change = function() {
      return this.builder.entity = this.entity_selector.value;
    };

    Editor.prototype.grid_move = function() {
      this.grid.x = parseInt(this.grid_x.value);
      this.grid.y = parseInt(this.grid_y.value);
      this.grid.width = parseInt(this.grid_width.value);
      return this.grid.height = parseInt(this.grid_height.value);
    };

    Editor.prototype.toggle_grid = function() {
      console.log('e');
      if (this.grid.visible) {
        return this.grid.visible = false;
      } else {
        return this.grid.visible = true;
      }
    };

    Editor.prototype.toggle_pause = function() {
      return this.set_pause(!Game.pause);
    };

    Editor.prototype.set_pause = function(pause) {
      var world, _i, _len, _ref, _results;
      Game.pause = pause;
      if (pause) {
        this.pause_button.innerHTML = 'Play';
      } else {
        this.pause_button.innerHTML = 'Pause';
      }
      _ref = Game.worlds;
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        world = _ref[_i];
        _results.push(world.pause = Game.pause);
      }
      return _results;
    };

    Editor.prototype.draw = function() {
      return this.grid.draw();
    };

    return Editor;

  })();

  Grid = (function() {

    Grid.prototype.sx = 0;

    Grid.prototype.sy = 0;

    Grid.prototype.visible = false;

    Grid.prototype.x = 0;

    Grid.prototype.y = 0;

    Grid.prototype.width = 16;

    Grid.prototype.height = 16;

    Grid.prototype.world_x = 0;

    Grid.prototype.world_y = 0;

    function Grid() {
      this.visible = AppData.grid_on;
    }

    Grid.prototype.draw = function() {
      var i, line_x_n, line_y_n, x, y, _i, _j;
      if (this.visible && this.height > 1 && this.width > 1) {
        Art.stroke_color('Gray');
        Art.alpha(0.5);
        line_x_n = AppData.width / this.width;
        line_y_n = AppData.height / this.height;
        for (i = _i = 0; 0 <= line_x_n ? _i < line_x_n : _i > line_x_n; i = 0 <= line_x_n ? ++_i : --_i) {
          x = this.x + i * this.width;
          Art.lineC(x, this.y, x, this.y + line_y_n * this.height);
        }
        for (i = _j = 0; 0 <= line_y_n ? _j < line_y_n : _j > line_y_n; i = 0 <= line_y_n ? ++_j : --_j) {
          y = this.y + i * this.height;
          Art.lineC(this.x, y, this.x + line_x_n * this.width, y);
        }
        return Art.alpha(1);
      }
    };

    return Grid;

  })();

  window.onload = function() {
    return Game.init('build');
  };

  AppData = (function() {

    function AppData() {}

    AppData.game_name = "template";

    AppData.width = 360;

    AppData.height = 240;

    AppData.scale = 2;

    AppData.grid_on = false;

    AppData.physics = true;

    AppData.physics_pixel_per_meter = 16;

    AppData.entities = {
      'Block': Block,
      'dbtest': dbtest,
      'Explosion': Explosion,
      'Fireball': Fireball,
      'GameController': GameController,
      'Hero': Hero
    };

    AppData.sprites = {
      'Block': 'Block.png',
      'Block16': 'Block16.png',
      'Explosion': 'Explosion.png',
      'Explosion2': 'Explosion2.png',
      'Explosion3': 'Explosion3.png',
      'Explosion4': 'Explosion4.png',
      'Fireball': 'Fireball.png',
      'Fireball2': 'Fireball2.png',
      'Fireball3': 'Fireball3.png',
      'Fireball4': 'Fireball4.png',
      'Fireball5': 'Fireball5.png',
      'Fireball6': 'Fireball6.png',
      'Fireball7': 'Fireball7.png',
      'Fireball8': 'Fireball8.png',
      'Heart': 'Heart.png',
      'Hero': 'Hero.png',
      'Hero10': 'Hero10.png',
      'Hero2': 'Hero2.png',
      'Hero3': 'Hero3.png',
      'Hero4': 'Hero4.png',
      'Hero5': 'Hero5.png',
      'Hero6': 'Hero6.png',
      'Hero7': 'Hero7.png',
      'Hero8': 'Hero8.png',
      'Hero9': 'Hero9.png',
      'PlaceHolder': 'PlaceHolder.png'
    };

    AppData.levels = {
      'Level': Level,
      'Level2': Level2
    };

    return AppData;

  })();

}).call(this);
